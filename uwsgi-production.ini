[uwsgi]
# Application
wsgi-file = main.py
callable = app
module = main:app

# Socket configuration - CRITICAL: Use 0.0.0.0 for Cloud Run
http = 0.0.0.0:5000
http-allow-methods = GET, POST, PUT, PATCH, DELETE, OPTIONS

# Process management - Start with 1 process for Cloud Run
master = true
processes = 1
threads = 2
enable-threads = true

# Lazy loading (important for Flask app initialization)
lazy = true
lazy-apps = true

# Worker lifecycle management
max-requests = 1000
max-requests-delta = 100
max-worker-lifetime = 3600
reload-on-rss = 512
worker-reload-mercy = 60

# Timeouts
harakiri = 300
socket-timeout = 300
http-timeout = 300

# Logging - VERBOSE for debugging
log-4xx = true
log-5xx = true
disable-logging = false
log-date = true
log-x-forwarded-for = true

# Performance
vacuum = true
die-on-term = true
need-app = true

# Signal handling for graceful shutdown (important for Cloud Run)
hook-master-start = unix_signal:15 gracefully_kill_them_all

# Buffer sizes
buffer-size = 32768
post-buffering = 8192

# Logging to stdout (important for Cloud Run)
logto = /dev/stdout

# Disable request logging for health checks
route-run = log:Health check - skipping log
route-if = equal:${PATH_INFO};/livez last:
route-if = equal:${PATH_INFO};/readyz last:

# Note: CORS headers are handled by Flask-CORS in main.py
# Do not add CORS headers here to avoid conflicts
